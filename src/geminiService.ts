
import { GoogleGenAI } from "@google/genai";
import { Message } from "./types";

// Initialize the Gemini API client using the mandatory environment variable.
const ai = new GoogleGenAI({ apiKey: process.env.API_KEY });

const TUTOR_SYSTEM_INSTRUCTION = `
  –¢—ã ‚Äî '–†–µ–ø–µ—Ç–∏—Ç–æ—Ä –ü–æ–¥ –†—É–∫–æ–π', –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ò–ò-—É—á–∏—Ç–µ–ª—å –¥–ª—è —à–∫–æ–ª—å–Ω–∏–∫–æ–≤. 
  
  –¢–í–û–ò –ü–†–ê–í–ò–õ–ê:
  1. –û–ë–©–ê–ô–°–Ø –¢–û–õ–¨–ö–û –ù–ê –†–£–°–°–ö–û–ú –Ø–ó–´–ö–ï.
  2. –ò—Å–ø–æ–ª—å–∑—É–π –º–µ—Ç–æ–¥ –°–æ–∫—Ä–∞—Ç–∞: –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–∞–≤–∞–π –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∑–∞–¥–∞–≤–∞–π –Ω–∞–≤–æ–¥—è—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø–æ–º–æ–≥–∞–π —É—á–µ–Ω–∏–∫—É –¥–æ–¥—É–º–∞—Ç—å—Å—è —Å–∞–º–æ–º—É.
  3. –ë—É–¥—å –¥–æ–±—Ä—ã–º –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–º. –•–≤–∞–ª–∏ –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –º—ã—Å–ª–∏.
  4. –ò—Å–ø–æ–ª—å–∑—É–π Markdown: –∂–∏—Ä–Ω—ã–π —à—Ä–∏—Ñ—Ç –¥–ª—è —Ç–µ—Ä–º–∏–Ω–æ–≤, —Å–ø–∏—Å–∫–∏ –¥–ª—è —ç—Ç–∞–ø–æ–≤ —Ä–µ—à–µ–Ω–∏—è, –±–ª–æ–∫–∏ –∫–æ–¥–∞ –¥–ª—è —Ñ–æ—Ä–º—É–ª.
  5. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–µ–¥–º–µ—Ç–∞ –∑–∞–¥–∞–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ì–µ–æ–º–µ—Ç—Ä–∏—è), –∏—Å–ø–æ–ª—å–∑—É–π —Ç–µ—Ä–º–∏–Ω–æ–ª–æ–≥–∏—é —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞.
  6. –ò—Å–ø–æ–ª—å–∑—É–π —É–º–µ—Å—Ç–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–º–æ–¥–∑–∏ (üòä, üìê, ‚ú®), —á—Ç–æ–±—ã –Ω–µ –±—ã—Ç—å —Å–ª–∏—à–∫–æ–º —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–º.
`;

export const getTutorResponse = async (history: Message[], subject?: string) => {
  const chat = ai.chats.create({
    model: 'gemini-3-flash-preview',
    config: {
      systemInstruction: TUTOR_SYSTEM_INSTRUCTION + (subject ? `\n–ö–æ–Ω—Ç–µ–∫—Å—Ç —É—Ä–æ–∫–∞: –ü—Ä–µ–¥–º–µ—Ç ‚Äî ${subject}.` : ""),
      temperature: 0.7,
    },
  });

  const lastMessage = history[history.length - 1].text;
  
  try {
    const result = await chat.sendMessage({
      message: lastMessage
    });
    // Access the text property directly from the response.
    return result.text || "–ò–∑–≤–∏–Ω–∏, –≤–æ–∑–Ω–∏–∫–ª–∞ –∑–∞–º–∏–Ω–∫–∞. –ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å? üòä";
  } catch (error) {
    console.error("Gemini Error:", error);
    return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏–ª–∏ –ø–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ.";
  }
};
